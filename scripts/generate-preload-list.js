#!/usr/bin/env node

/**
 * Generate Preload List Script
 * Analyzes the built bundle and generates critical resource hints for optimal loading
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const DIST_DIR = path.join(process.cwd(), 'dist');
const PRELOAD_FILE = path.join(DIST_DIR, 'preload-hints.html');
const CRITICAL_CSS_THRESHOLD = 2 * 1024; // 2KB
const CRITICAL_JS_THRESHOLD = 5 * 1024; // 5KB

function analyzeBundle() {
  const assets = {};
  const manifestPath = path.join(DIST_DIR, '.vite', 'manifest.json');
  
  if (!fs.existsSync(manifestPath)) {
    console.warn('Vite manifest not found, skipping preload analysis');
    return null;
  }

  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
  
  for (const [key, entry] of Object.entries(manifest)) {
    if (typeof entry === 'object' && entry.file) {
      const filePath = path.join(DIST_DIR, entry.file);
      if (fs.existsSync(filePath)) {
        const stats = fs.statSync(filePath);
        assets[key] = {
          file: entry.file,
          size: stats.size,
          type: getFileType(entry.file),
          imports: entry.imports || [],
          dynamicImports: entry.dynamicImports || []
        };
      }
    }
  }

  return assets;
}

function getFileType(filename) {
  const ext = path.extname(filename);
  switch (ext) {
    case '.js': return 'script';
    case '.css': return 'style';
    case '.woff':
    case '.woff2':
    case '.ttf':
    case '.eot': return 'font';
    case '.png':
    case '.jpg':
    case '.jpeg':
    case '.gif':
    case '.svg':
    case '.webp': return 'image';
    default: return 'other';
  }
}

function generatePreloadHints(assets) {
  if (!assets) return '';

  const hints = [];
  const criticalAssets = [];

  // Identify critical assets
  for (const [key, asset] of Object.entries(assets)) {
    // Main entry points are critical
    if (key === 'main.tsx' || key === 'index.html' || key.includes('main')) {
      criticalAssets.push(asset);
    }
    // Small CSS files are critical
    else if (asset.type === 'style' && asset.size < CRITICAL_CSS_THRESHOLD) {
      criticalAssets.push(asset);
    }
    // Small JS chunks that are likely polyfills or core functionality
    else if (asset.type === 'script' && asset.size < CRITICAL_JS_THRESHOLD) {
      criticalAssets.push(asset);
    }
  }

  // Generate preload hints for critical assets
  for (const asset of criticalAssets) {
    const attributes = [];
    
    switch (asset.type) {
      case 'script':
        attributes.push('rel="preload"', 'href="/' + asset.file + '"', 'as="script"');
        break;
      case 'style':
        attributes.push('rel="preload"', 'href="/' + asset.file + '"', 'as="style"');
        break;
      case 'font':
        attributes.push('rel="preload"', 'href="/' + asset.file + '"', 'as="font"', 'type="font/woff2"', 'crossorigin');
        break;
      case 'image':
        attributes.push('rel="preload"', 'href="/' + asset.file + '"', 'as="image"');
        break;
    }

    if (attributes.length > 0) {
      hints.push(`  <link ${attributes.join(' ')}>`);
    }
  }

  // Generate preconnect hints for external domains
  const preconnectDomains = [
    'https://fonts.googleapis.com',
    'https://fonts.gstatic.com',
    'https://*.supabase.co',
    'https://googleapis.com',
    'https://www.google-analytics.com'
  ];

  for (const domain of preconnectDomains) {
    hints.push(`  <link rel="preconnect" href="${domain}">`);
  }

  // Generate DNS prefetch hints for less critical domains
  const dnsPrefetchDomains = [
    'https://cdn.vercel-insights.com',
    'https://region1.google-analytics.com'
  ];

  for (const domain of dnsPrefetchDomains) {
    hints.push(`  <link rel="dns-prefetch" href="${domain}">`);
  }

  return hints.join('\n');
}

function generateModulePreload(assets) {
  if (!assets) return '';

  const hints = [];
  
  // Generate modulepreload for modern browsers
  for (const [key, asset] of Object.entries(assets)) {
    if (asset.type === 'script' && (key.includes('vendor') || key.includes('chunk'))) {
      hints.push(`  <link rel="modulepreload" href="/${asset.file}">`);
    }
  }

  return hints.join('\n');
}

function generateCriticalCSS() {
  // This would typically be generated by a tool like Critters
  // For now, return a placeholder
  return `
  <style>
    /* Critical CSS would be inlined here */
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Oxygen','Ubuntu','Cantarell','Fira Sans','Droid Sans','Helvetica Neue',sans-serif}
  </style>`;
}

function generatePreloadHTML() {
  const assets = analyzeBundle();
  
  if (!assets) {
    console.log('No assets found to analyze');
    return;
  }

  const preloadHints = generatePreloadHints(assets);
  const modulePreload = generateModulePreload(assets);
  const criticalCSS = generateCriticalCSS();

  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuantForge AI - Preload Hints</title>
  
  <!-- Critical CSS -->
${criticalCSS}
  
  <!-- Preload Critical Resources -->
${preloadHints}
  
  <!-- Module Preload for Modern Browsers -->
${modulePreload}
  
  <!-- Preconnect for External Domains -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- DNS Prefetch for Performance -->
  <link rel="dns-prefetch" href="https://cdn.vercel-insights.com">
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    .asset-list {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .asset-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #ddd;
    }
    .asset-item:last-child {
      border-bottom: none;
    }
    .critical {
      color: #d73a49;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>QuantForge AI - Bundle Analysis & Preload Hints</h1>
  
  <h2>Critical Resources (Preloaded)</h2>
  <div class="asset-list">
    ${Object.entries(assets)
      .filter(([key, asset]) => 
        key.includes('main') || 
        (asset.type === 'style' && asset.size < CRITICAL_CSS_THRESHOLD) ||
        (asset.type === 'script' && asset.size < CRITICAL_JS_THRESHOLD)
      )
      .map(([key, asset]) => `
        <div class="asset-item critical">
          <span>${key}</span>
          <span>${asset.file} (${(asset.size / 1024).toFixed(2)}KB)</span>
        </div>
      `).join('')}
  </div>
  
  <h2>All Assets</h2>
  <div class="asset-list">
    ${Object.entries(assets)
      .map(([key, asset]) => `
        <div class="asset-item">
          <span>${key}</span>
          <span>${asset.file} (${(asset.size / 1024).toFixed(2)}KB)</span>
        </div>
      `).join('')}
  </div>
  
  <h2>Bundle Statistics</h2>
  <div class="asset-list">
    <div class="asset-item">
      <span>Total Assets</span>
      <span>${Object.keys(assets).length}</span>
    </div>
    <div class="asset-item">
      <span>Total Size</span>
      <span>${(Object.values(assets).reduce((sum, asset) => sum + asset.size, 0) / 1024).toFixed(2)}KB</span>
    </div>
    <div class="asset-item">
      <span>Critical Assets</span>
      <span>${Object.values(assets).filter(asset => 
        asset.type === 'style' && asset.size < CRITICAL_CSS_THRESHOLD ||
        asset.type === 'script' && asset.size < CRITICAL_JS_THRESHOLD
      ).length}</span>
    </div>
  </div>
  
  <script>
    // Performance monitoring
    window.addEventListener('load', () => {
      const perfData = performance.getEntriesByType('navigation')[0];
      console.log('Page Load Performance:', {
        domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
        loadComplete: perfData.loadEventEnd - perfData.loadEventStart,
        totalLoadTime: perfData.loadEventEnd - perfData.fetchStart
      });
    });
  </script>
</body>
</html>`;

  fs.writeFileSync(PRELOAD_FILE, html);
  console.log(`✅ Preload hints generated: ${PRELOAD_FILE}`);
  
  // Also generate a JSON file for programmatic use
  const preloadData = {
    generated: new Date().toISOString(),
    assets: assets,
    criticalAssets: Object.entries(assets).filter(([key, asset]) => 
      key.includes('main') || 
      (asset.type === 'style' && asset.size < CRITICAL_CSS_THRESHOLD) ||
      (asset.type === 'script' && asset.size < CRITICAL_JS_THRESHOLD)
    ),
    preloadHints: preloadHints.split('\n').filter(hint => hint.trim()),
    modulePreload: modulePreload.split('\n').filter(hint => hint.trim())
  };
  
  fs.writeFileSync(
    path.join(DIST_DIR, 'preload-data.json'),
    JSON.stringify(preloadData, null, 2)
  );
  console.log(`✅ Preload data generated: ${path.join(DIST_DIR, 'preload-data.json')}`);
}

// Run the generator
if (import.meta.url === `file://${process.argv[1]}`) {
  generatePreloadHTML();
}

export { generatePreloadHTML, analyzeBundle };